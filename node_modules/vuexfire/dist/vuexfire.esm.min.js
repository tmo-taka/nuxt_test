/*!
  * vuexfire v3.2.0-alpha.0
  * (c) 2019 Eduardo San Martin Morote
  * @license MIT
  */
var e="vuexfire/SET_VALUE",t="vuexfire/ARRAY_ADD",n="vuexfire/ARRAY_REMOVE";function r(e){return e&&"object"==typeof e}function o(e,t){for(var n=0;n<e.length;n++)if(e[n][".key"]===t)return n;return-1}var i={reset:!0,serialize:function(e){var t=e.val(),n=r(t)?t:Object.defineProperty({},".value",{value:t});return Object.defineProperty(n,".key",{value:e.key}),n},wait:!1};function a(e,t,n,o){void 0===t&&(t={}),void 0===n&&(n=""),void 0===o&&(o=[{},{}]),t=t||{};var i=o[0],u=o[1],c=Object.getOwnPropertyDescriptor(e,"id");c&&!c.enumerable&&Object.defineProperty(i,"id",c);var s=function(o){var c,s=e[o];if((c=s)&&c.onSnapshot)i[o]=t[o]||s.path,u[n+o]=s;else if(Array.isArray(s)){i[o]=Array(s.length);var f=(t[o]||[]).filter(function(e){return-1!==s.indexOf(e)});a(s,f,n+o+".",[i[o],u])}else null==s||s instanceof Date||function(e){return e.toDate}(s)||s.longitude&&s.latitude?i[o]=s:r(s)?(i[o]={},a(s,t[o],n+o+".",[i[o],u])):i[o]=s};for(var f in e)s(f);return o}var u,c={maxRefDepth:2,reset:!0,serialize:function(e){return Object.defineProperty(e.data(),"id",{value:e.id})},wait:!1};function s(e){for(var t in e)e[t].unsub()}function f(e,t){var n=e.snapshot,r=e.target,o=e.path,i=e.subs,u=e.ops,c=e.depth,s=e.resolve,f=a(n,function(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}(r,o)),l=f[0],v=f[1];u.set(r,o,l),d({subs:i,refs:v,target:r,path:o,ops:u,depth:c,resolve:s},t)}function l(e,t){var n=e.ref,r=e.target,o=e.path,i=e.depth,a=e.resolve,u=e.ops,c=Object.create(null),l=n.onSnapshot(function(e){e.exists?f({snapshot:t.serialize(e),target:r,path:o,ops:u,subs:c,depth:i,resolve:a},t):(u.set(r,o,null),a(o))});return function(){l(),s(c)}}function d(e,t){var n=e.subs,r=e.refs,o=e.target,i=e.path,a=e.depth,u=e.ops,c=e.resolve,s=Object.keys(r);if(Object.keys(n).filter(function(e){return s.indexOf(e)<0}).forEach(function(e){n[e].unsub(),delete n[e]}),!s.length||++a>t.maxRefDepth)return c(i);var f=0,d=s.length,v=Object.create(null);function p(e){e in v&&++f>=d&&c(i)}s.forEach(function(e){var c=n[e],s=r[e],f=i+"."+e;if(v[f]=!0,c){if(c.path===s.path)return;c.unsub()}n[e]={unsub:l({ref:s,target:o,path:f,depth:a,ops:u,resolve:p.bind(null,f)},t),path:s.path}})}var v=((u={})[e]=function(e,t){var n=t.path;!function(e,t,n){var r=(""+t).split("."),o=r.pop(),i=r.reduce(function(e,t){return e[t]},e);Array.isArray(i)?i.splice(Number(o),1,n):i[o]=n}(t.target,n,t.data)},u[t]=function(e,t){var n=t.newIndex,r=t.data;t.target.splice(n,0,r)},u[n]=function(e,t){var n=t.oldIndex;return t.target.splice(n,1)[0]},u),p=function(){return(p=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},h={root:!0},b=new WeakMap;function g(e,t,n,r,a,u){var c=b.get(t);return c||(c=Object.create(null),b.set(t,c)),n in c&&y(t,n,u&&u.reset),new Promise(function(t,s){c[n]=Array.isArray(e[n])?function(e,t){var n=e.vm,r=e.key,a=e.collection,u=e.resolve,c=e.reject,s=e.ops;void 0===t&&(t=i);var f=Object.assign({},i,t),l=f.wait?[]:s.set(n,r,[]),d=a.on("child_added",function(e,t){var n=t?o(l,t)+1:0;s.add(l,n,f.serialize(e))},c),v=a.on("child_removed",function(e){s.remove(l,o(l,e.key))},c),p=a.on("child_changed",function(e){s.set(l,o(l,e.key),f.serialize(e))},c),h=a.on("child_moved",function(e,t){var n=o(l,e.key),r=s.remove(l,n)[0],i=t?o(l,t)+1:0;s.add(l,i,r)},c);return a.once("value",function(e){f.wait&&s.set(n,r,l),u(e)}),function(e){if(a.off("child_added",d),a.off("child_changed",p),a.off("child_removed",v),a.off("child_moved",h),!1!==e){var t="function"==typeof e?e():[];s.set(n,r,t)}}}({vm:e,key:n,collection:r,ops:a,resolve:t,reject:s},u):function(e,t){var n=e.vm,r=e.key,o=e.document,a=e.resolve,u=e.reject,c=e.ops;void 0===t&&(t=i);var s=Object.assign({},i,t),f=o.on("value",function(e){c.set(n,r,s.serialize(e))},u);return o.once("value",a),function(e){if(o.off("value",f),!1!==e){var t="function"==typeof e?e():null;c.set(n,r,t)}}}({vm:e,key:n,document:r,ops:a,resolve:t,reject:s},u)})}function y(e,t,n){var r=b.get(e);r&&r[t]&&(r[t](n),delete r[t])}function m(r){return function(o,a){var u=o.state,c=o.commit,s={set:function(t,n,r){return c(e,{path:n,target:t,data:r},h),r},add:function(e,n,r){return c(t,{target:e,newIndex:n,data:r},h)},remove:function(e,t){var r=e[t];return c(n,{target:e,oldIndex:t},h),[r]}};return r.call(this,p({},o,{bindFirebaseRef:function(e,t,n){return g(u,c,e,t,s,Object.assign({},i,n))},unbindFirebaseRef:function(e,t){return y(c,e,t)}}),a)}}var j={root:!0},O=new WeakMap;function w(e,t,n,r,o,i){var u=O.get(t);return u||(u=Object.create(null),O.set(t,u)),n in u&&x(t,n,i.wait?"function"==typeof i.reset&&i.reset:i.reset),new Promise(function(t,l){u[n]="where"in r?function(e,t){var n=e.vm,r=e.key,o=e.collection,i=e.ops,u=e.resolve,f=e.reject;void 0===t&&(t=c);var l,v=Object.assign({},c,t),p=v.wait?[]:i.set(n,r,[]),h=u,b=[],g={added:function(e){var t=e.newIndex,n=e.doc;b.splice(t,0,Object.create(null));var r=b[t],o=a(v.serialize(n)),c=o[0],s=o[1];i.add(p,t,c),d({refs:s,subs:r,target:p,path:t,depth:0,ops:i,resolve:u.bind(null,n)},v)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=b.splice(t,1)[0];b.splice(n,0,o);var c=i.remove(p,t)[0],s=a(v.serialize(r),c),f=s[0],l=s[1];i.add(p,n,f),d({refs:l,subs:o,ops:i,target:p,path:n,depth:0,resolve:u},v)},removed:function(e){var t=e.oldIndex;i.remove(p,t),s(b.splice(t,1)[0])}},y=o.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!l&&t.length){l=!0;for(var o=0,a=t.length,c=Object.create(null),s=0;s<a;s++)c[t[s].doc.id]=!0;u=function(e){e.id in c&&++o>=a&&(v.wait&&i.set(n,r,p),h(n[r]),u=function(){})}}t.forEach(function(e){g[e.type](e)}),t.length||(v.wait&&i.set(n,r,p),u())},f);return function(e){if(y(),!1!==e){var t="function"==typeof e?e():[];i.set(n,r,t)}b.forEach(s)}}({vm:e,key:n,collection:r,ops:o,resolve:t,reject:l},i):function(e,t){var n=e.vm,r=e.key,o=e.document,i=e.resolve,a=e.reject,u=e.ops;void 0===t&&(t=c);var l,d,v,p=Object.assign({},c,t),h=Object.create(null);l=i,d=function(){return n[r]},v=!1,i=function(){if(!v)return v=!0,l(d())};var b=o.onSnapshot(function(e){e.exists?f({snapshot:p.serialize(e),target:n,path:r,subs:h,ops:u,depth:0,resolve:i},p):i()},a);return function(e){if(b(),!1!==e){var t="function"==typeof e?e():null;u.set(n,r,t)}s(h)}}({vm:e,key:n,document:r,ops:o,resolve:t,reject:l},i)})}function x(e,t,n){var r=O.get(e);r&&r[t]&&(r[t](n),delete r[t])}function k(r){return function(o,i){var a=o.state,u=o.commit,s={set:function(t,n,r){return u(e,{path:n,target:t,data:r},j),r},add:function(e,n,r){return u(t,{target:e,newIndex:n,data:r},j)},remove:function(e,t){var r=e[t];return u(n,{target:e,oldIndex:t},j),[r]}};return r.call(this,p({},o,{bindFirestoreRef:function(e,t,n){return w(a,u,e,t,s,Object.assign({},c,n))},unbindFirestoreRef:function(e,t){return x(u,e,t)}}),i)}}export{m as firebaseAction,k as firestoreAction,c as firestoreOptions,i as rtdbOptions,v as vuexfireMutations};
